- name: Create cilium-secrets namespace
  delegate_to: localhost
  become: false
  kubernetes.core.k8s:
    name: cilium-secrets
    api_version: v1
    kind: Namespace
    state: present

- name: Deploy Cilium 1.17.x
  delegate_to: localhost
  become: false
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    chart_version: 1.17.x
    release_namespace: kube-system
    wait: true
    values:
      k8sServiceHost: "172.16.1.171"
      k8sServicePort: "6443"
      kubeProxyReplacement: "true"
      ipv4:
        enabled: true
      ipv6:
        enabled: false
      tls:
        secretsNamespace:
          create: false
      operator:
        replicas: 1
      ipam:
        operator:
          clusterPoolIPv4PodCIDRList: "10.42.0.0/16"
          clusterPoolIPv4MaskSize: 24
      set-cilium-node-taints: "false"
      devices: eth0
      routingMode: native
      ipv4NativeRoutingCIDR: 10.244.0.0/16
      enableIPv4Masquerade: true
      autoDirectNodeRoutes: true
      l2announcements:
        enabled: true
      loadBalancer:
        l7:
          backend: envoy
      rollOutCiliumPods: true
      hubble:
        enabled: true
        ui:
          enabled: true
          rollOutPods: true
          tolerations:
          - key: node-role.kubernetes.io/control-plane
            operator: Exists
            effect: NoSchedule
          - key: node-role.kubernetes.io/master
            operator: Exists
            effect: NoSchedule
        relay:
          enabled: true
          rollOutPods: true
          tolerations:
          - key: node-role.kubernetes.io/control-plane
            operator: Exists
            effect: NoSchedule
          - key: node-role.kubernetes.io/master
            operator: Exists
            effect: NoSchedule
      routingMode: "native"
      ingressController:
        enabled: true
        default: true
        service:
          externalTrafficPolicy: Cluster
          type: LoadBalancer
        loadbalancerMode: dedicated
      externalIPs:
        enabled: true
      loadBalancerIPs:
        enabled: true
 
- name: Wait for Cilium resources
  ansible.builtin.command: >-
    {% if item.type == 'daemonset' %}
    {{ k3s_kubectl_binary | default('k3s kubectl') }} wait pods
    --namespace=kube-system
    --selector='k8s-app=cilium'
    --for=condition=Ready
    {% else %}
    {{ k3s_kubectl_binary | default('k3s kubectl') }} wait {{ item.type }}/{{ item.name }}
    --namespace=kube-system
    --for=condition=Available
    {% endif %}
    --timeout=30s
  register: cr_result
  changed_when: false
  until: cr_result is succeeded
  retries: 30
  vars:
    cilium_hubble: true
  delay: 7
  with_items:
    - { name: cilium-operator, type: deployment }
    - { name: cilium, type: daemonset, selector: k8s-app=cilium }
    - { name: hubble-relay, type: deployment, check_hubble: true }
    - { name: hubble-ui, type: deployment, check_hubble: true }
  loop_control:
    label: "{{ item.type }}/{{ item.name }}"
  when: >-
    not item.check_hubble | default(false) or (item.check_hubble | default(false) and cilium_hubble)