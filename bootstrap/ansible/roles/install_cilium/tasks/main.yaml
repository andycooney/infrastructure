# - name: Pause
#   pause:
#     seconds: 15

# - name: Install Cilium
#   ansible.builtin.command:
#     cmd: cilium install \
#           --version 1.17.1 \
#           --set k8sServiceHost="172.16.1.171" \
#           --set k8sServicePort="6443" \
#           --set kubeProxyReplacement=true \
#           --set tls.secretsNamespace.create=false \
#           --set ipam.operator.clusterPoolIPv4PodCIDRList="10.42.0.0/16" \
#           --namespace kube-system

# - name: Install via command
#   command:
#     cmd: helm install cilium cilium/cilium --version 1.17.1 --namespace kube-system --set kubeProxyReplacement=true --set operator.replicas=1 --set ipam.operator.clusterPoolIPv4PodCIDRList="10.42.0.0/16" --set operator.replicas=1

# this command worked
# helm install cilium cilium/cilium --version 1.17.1 \
# --namespace kube-system \
# --set kubeProxyReplacement=true \
# --set operator.replicas=1 \
# --set ipam.operator.clusterPoolIPv4PodCIDRList="10.42.0.0/16" \
# --set k8sServiceHost="172.16.1.171" \
# --set k8sServicePort="6443" \
# --set tls.secretsNamespace.create=false

# - name: Deploy latest version of Grafana chart inside monitoring namespace with values
#   kubernetes.core.helm:
#     name: test
#     chart_ref: stable/grafana
#     release_namespace: monitoring
#     values:
#       replicas: 2

- name: Create cilium-secrets namespace
  kubernetes.core.k8s:
    name: cilium-secrets
    api_version: v1
    kind: Namespace
    state: present

- name: Deploy Cilium 1.17.x
  kubernetes.core.helm:
    name: cilium
    chart_ref: cilium/cilium
    chart_version: 1.17.x
    release_namespace: kube-system
    # values: "{{ lookup('template', 'somefile.yaml') | from_yaml }}"
    values:
      # namespace: "kube-system"
      # namespaceOverride: "kube-system"
      k8sServiceHost: "172.16.1.171"
      k8sServicePort: "6443"
      kubeProxyReplacement: "true"
      tls:
        secretsNamespace:
          create: false
      operator:
        replicas: 1
      ipam:
        operator:
          clusterPoolIPv4PodCIDRList: "10.42.0.0/16"


# - name: Pause
#   pause:
#     seconds: 45