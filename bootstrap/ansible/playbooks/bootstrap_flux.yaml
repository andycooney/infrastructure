- name: Bootstrap Flux
  hosts: localhost
  become: false
  gather_facts: false
  tasks:

  - name: Include all default extension files in vars/all and all nested directories and save the output in test. (2.2)
    ansible.builtin.include_vars:
      dir: "{{ project_path }}/bootstrap/ansible/group_vars"

  - name: Create a k8s namespace
    kubernetes.core.k8s:
      name: flux-system
      api_version: v1
      kind: Namespace
      state: present

  - name: Add secrets for 1Password integration
    kubernetes.core.k8s:
      state: present
      definition: 
        apiVersion: v1
        kind: Secret
        type: Opaque             
        metadata:
          name: "onepassword-token"
          namespace: "flux-system"     
        data:
          config_data.json: "{{ onepass_token }}"

  - name: Add secrets for 1Password integration
    kubernetes.core.k8s:
      state: present
      definition: 
        apiVersion: v1
        kind: Secret
        type: Opaque             
        metadata:
          name: "op-credentials"
          namespace: "flux-system"     
        data:
          config_data.json: "{{ onepass_credentials }}"

  # - name: Bootstrap Flux
  #   become: false
  #   command:
  #     cmd: echo {{ github_token }} | flux bootstrap github --token-auth --owner="{{ github_user }}" --repository="{{ github_repo }}" --branch="{{ github_branch }}" --path="{{ github_path }}" --personal --force
  # # tasks:
  # #   - block:
  # #     - command:
  # #         # cmd: 'echo $GITHUB_TOKEN'
  # #         cmd: flux bootstrap github --token-auth --owner="{{ github_user }}" --repository="{{ github_repo }}" --branch="{{ github_branch }}" --path="{{ github_path }}" --personal --force
  # #       register: result
  # #     - debug:
  # #         var: result.stdout
  #   environment:
  #     GITHUB_TOKEN: "{{ github_token }}"