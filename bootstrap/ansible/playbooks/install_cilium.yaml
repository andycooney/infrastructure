- name: Install Cilium
  hosts: localhost
  become: false
  tasks:
    - name: Create cilium-secrets namespace
      kubernetes.core.k8s:
        name: cilium-secrets
        api_version: v1
        kind: Namespace
        state: present
    - name: Deploy Cilium 1.17.x
      kubernetes.core.helm:
        name: cilium
        chart_ref: cilium/cilium
        chart_version: 1.17.x
        release_namespace: kube-system
        values:
          cluster:
            name: k3s-ansible
          k8sServiceHost: "172.16.1.171"
          k8sServicePort: "6443"
          kubeProxyReplacement: "true"
          ipv4:
            enabled: true
          ipv6:
            enabled: false
          tls:
            secretsNamespace:
              create: false
          operator:
            replicas: 1
          ipam:
            operator:
              clusterPoolIPv4PodCIDRList: "10.42.0.0/16"
              clusterPoolIPv4MaskSize: 24
          set-cilium-node-taints: "false"
          devices: eth0
          routingMode: native
          ipv4NativeRoutingCIDR: 10.244.0.0/16
          enableIPv4Masquerade: true
          autoDirectNodeRoutes: true
    
    - name: Wait for Cilium resources
      ansible.builtin.command: >-
        kubectl wait pods
        --namespace=kube-system
        --selector='k8s-app=cilium'
        --for=condition=Ready
        --timeout=30s
      register: cr_result
      changed_when: false
      until: cr_result is succeeded
      retries: 30
      delay: 7
